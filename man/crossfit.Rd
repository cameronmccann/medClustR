% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/crossfit.R
\name{crossfit}
\alias{crossfit}
\title{crossfit}
\usage{
crossfit(
  train,
  valid.list,
  yname,
  xnames,
  varnames,
  ipw = NULL,
  cluster_opt = "FE.glm",
  type,
  learners,
  bounded = FALSE,
  random_slope_vars = NULL,
  source_label = NULL
)
}
\arguments{
\item{train}{A data frame containing the training set/fold (used to fit the model).
Must include the outcome \code{yname}, predictors \code{xnames} (and any \code{varnames$W}),
and the cluster identifier \code{varnames$S}.}

\item{valid.list}{A list of one or more data frames. Each data frame is a
validation set/fold used for prediction. Must contain the same variables as
\code{train} needed by the chosen \code{cluster_opt}.}

\item{yname}{Character string specifying the outcome variable name (e.g., \code{"Y"}).}

\item{xnames}{Character vector of predictor variable names (e.g., \code{c("X1", "X2")}).}

\item{varnames}{List containing named elements that specify additional variables:
\itemize{
\item \code{S}: The cluster identifier variable name.
\item \code{Sdumm}: Vector of dummy variable names (required for
\code{cluster_opt = "fix.mlr"} and used by \code{cluster_opt = "cwc.FE"}). Can be \code{NULL}
otherwise.
\item \code{W}: (Optional) Additional covariate names to include.
}}

\item{ipw}{(Optional) Numeric vector of inverse probability weights to use during model fitting.
If \code{NULL} (default), all observations receive weight 1.}

\item{cluster_opt}{Character string specifying the clustering or modeling approach.
Possible values include \code{"RE.glm"}, \code{"FE.glm"}, \code{"noncluster.glm"}, \code{"fix.mlr"},
\code{"noncluster.mlr"}, \code{"cwc"}, \code{"sufficient_stats"}, \code{"cwc.FE"}.
See Details for how each is handled.}

\item{type}{Character string specifying the outcome family/distribution, such as \code{"binomial"} or \code{"gaussian"}.}

\item{learners}{Character vector specifying a SuperLearner library
(passed to \code{SuperLearner::SuperLearner} as \code{SL.library}) when
\code{cluster_opt} uses SuperLearner. Ignored for GLM / random-effect models.}

\item{bounded}{Logical. If \code{TRUE}, apply \code{bound()} to predictions before
returning. Default is \code{FALSE}.}

\item{random_slope_vars}{Optional character vector of variable names to use
as random slopes when \code{cluster_opt = "RE.glm.rs"}. If \code{NULL} or empty, the
function falls back to a random-intercept-only structure and issues a
warning.}

\item{source_label}{Optional character scalar used to prefix informational
messages/warnings (useful when \code{crossfit()} is called inside other
functions).}
}
\value{
A list with two elements:
\describe{
\item{\code{fit}}{The fitted model object (e.g., a \code{glm}, \code{lmer}, or \code{SuperLearner} object).}
\item{\code{preds}}{A matrix or vector of predictions, with one column per validation set if there are multiple
entries in \code{valid.list}.}
}
}
\description{
Fits a model (either random effects, fixed effects, or a SuperLearner approach) on
a training dataset and uses it to predict outcomes on a set of validation datasets.
}
\details{
The \code{crossfit()} function is primarily used for cross-fitting.
The \code{cluster_opt} argument selects:
\itemize{
\item \code{"RE.glm"}: Random-effect model via \code{lme4::lmer} (Gaussian)
or \code{lme4::glmer} (Binomial), with a random intercept for the cluster identifier \code{S}.

\item \code{"RE.glm.rs"}: Random-effect model with random slopes for variables in
\code{random_slope_vars} via \code{lme4::lmer}/\code{lme4::glmer}.

\item \code{"FE.glm"}: GLM with cluster fixed effects by including \code{S}.

\item \code{"noncluster.glm"}: GLM without any fixed effects.

\item \code{"fix.mlr"} or \code{"noncluster.mlr"}: SuperLearner-based prediction using cluster dummies or not.

\item \code{"sufficient_stats"}: Centered within clusters or sufficient statistics approach.

\item \code{"cwc"}: SuperLearner using centered-within-cluster covariates
(expects columns \code{paste0(xnames, "_cwc")} and \code{paste0(xnames, "_clmean")}
and \code{paste0(yname, "_clmean")} in the input data).

\item \code{"cwc.FE"}: SuperLearner using centered-within-cluster covariates
plus cluster dummy indicators (expects dummy names in \code{varnames$Sdumm} and
centered features \code{paste0(xnames, "_cwc")}).
}

When \code{bounded = TRUE}, predictions are passed through \code{bound()} to keep
predictions in a valid range.
}
\examples{
\dontrun{
# Example: binomial GLM with cluster fixed effects
set.seed(1)
train <- data.frame(
  Y = rbinom(100, 1, 0.3),
  X1 = rnorm(100),
  X2 = rnorm(100),
  S  = sample(1:5, 100, replace = TRUE)
)
valid <- data.frame(
  Y = rbinom(50, 1, 0.3),
  X1 = rnorm(50),
  X2 = rnorm(50),
  S  = sample(1:5, 50, replace = TRUE)
)

out <- crossfit(
  train = train,
  valid.list = list(valid),
  yname = "Y",
  xnames = c("X1", "X2"),
  varnames = list(S = "S", Sdumm = NULL, W = NULL),
  cluster_opt = "FE.glm",
  type = "binomial",
  learners = NULL,
  bounded = TRUE
)
head(out$preds)

# Example: SuperLearner with explicit cluster dummies (user must create them)
# train$Sd1 <- as.integer(train$S == 1)
# train$Sd2 <- as.integer(train$S == 2)
# valid$Sd1 <- as.integer(valid$S == 1)
# valid$Sd2 <- as.integer(valid$S == 2)
#
# out_sl <- crossfit(
#   train = train,
#   valid.list = list(valid),
#   yname = "Y",
#   xnames = c("X1", "X2"),
#   varnames = list(S = "S", Sdumm = c("Sd1","Sd2"), W = NULL),
#   cluster_opt = "fix.mlr",
#   type = "binomial",
#   learners = c("SL.mean","SL.glm"),
#   bounded = TRUE
# )
}

}
\seealso{
\code{\link[lme4]{lmer}}, \code{\link[lme4]{glmer}},
\code{\link[stats]{glm}}, \code{\link[SuperLearner]{SuperLearner}}
}
